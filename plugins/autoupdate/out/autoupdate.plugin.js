// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  module.exports = function(BasePlugin) {
    var AutoUpdatePlugin;
    return AutoUpdatePlugin = (function(_super) {

      __extends(AutoUpdatePlugin, _super);

      AutoUpdatePlugin.prototype.name = 'autoupdate';

      function AutoUpdatePlugin() {
        AutoUpdatePlugin.__super__.constructor.apply(this, arguments);
        this.now = require('now');
      }

      AutoUpdatePlugin.prototype.renderBefore = function(_arg, next) {
        var templateData;
        templateData = _arg.templateData;
        templateData.blocks.scripts.push("<script src=\"/nowjs/now.js\"></script>\n<script>\n	// Wait for now\n	window.now.ready(function(){\n		// Handshake\n		window.now.docpadHandshake(\n			// Sync notify\n			function (documentId, state) {\n				document.location.reload();\n			},\n			// Callback\n			function (clientId) {\n				console.log('DocPad AutoUpdate plugin now ready');\n			}\n		);\n	});\n</script>");
        return next();
      };

      AutoUpdatePlugin.prototype.serverAfter = function(_arg, next) {
        var server,
          _this = this;
        server = _arg.server;
        this.everyone = this.now.initialize(server, {
          clientWrite: false
        });
        this.everyone.now.docpadHandshake = function(docpadSync, next) {
          if (typeof docpadSync !== 'function') {
            console.log('Evil client');
            return false;
          }
          _this.now.docpadSync = docpadSync;
          if (next) {
            return next();
          }
        };
        return next();
      };

      AutoUpdatePlugin.prototype.writeAfter = function(_arg, next) {
        _arg;
        if (this.now.docpadSync) {
          this.now.docpadSync();
        }
        return next();
      };

      return AutoUpdatePlugin;

    })(BasePlugin);
  };

}).call(this);
